<!DOCTYPE html>
<html lang="en" class="index-page">
<head>
    <title>SENTION Dashboard</title>
    <link rel="icon" type="image/png" href="https://i.postimg.cc/FRwbMSBN/SENTION-logo-Black-Transparent-BG.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='tooltip-styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- PDF export libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Dashboard styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            color: #333;
            background-color: #f9f9fb;
            line-height: 1.6;
        }
        
        .dashboard-container {
            padding: 20px 0;
        }
        
        .card {
            border-radius: 10px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }
        
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 20px;
            border-radius: 10px 10px 0 0 !important;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .dashboard-section {
            margin-bottom: 40px;
        }
        
        .dashboard-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 20px;
            border-bottom: 1px solid #eaeaea;
            padding-bottom: 10px;
        }
        
        /* Chart container styling */
        #chart-container {
            height: 400px;
            width: 100%;
            position: relative;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 15px;
        }
        
        #chart-controls {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .chart-toggle-btn {
            cursor: pointer;
        }
        
        /* Existing styling continues... */
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            animation: fadeInUp 0.8s ease-out;
            position: relative;
            overflow: hidden;
        }

        .dashboard-container:hover {
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .dashboard-container h2 {
            color: #333;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 30px;
            position: relative;
            text-align: left;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .dashboard-section {
            margin-bottom: 40px;
        }

        .dashboard-section h3 {
            color: #555;
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
            position: relative;
            padding-left: 15px;
            border-left: 3px solid #8c857d;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            border-left: 4px solid #8c857d;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-card h4 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #444;
        }

        .summary-card p {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .summary-card .trend {
            font-size: 14px;
            color: #666;
        }

        .trend-up {
            color: #28a745;
        }

        .trend-down {
            color: #dc3545;
        }

        .data-visualization {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            height: 300px;
        }

        .resource-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        .resource-table th,
        .resource-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .resource-table thead th {
            background-color: #f8f9fa;
            color: #333;
            font-weight: 600;
            position: relative;
        }

        .resource-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .risk-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .risk-none {
            background-color: #e2f2e6;
            color: #28a745;
        }

        .risk-low {
            background-color: #fff3cd;
            color: #ffc107;
        }

        .risk-high {
            background-color: #f8d7da;
            color: #dc3545;
        }
        
        /* Export button loading states */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.8;
        }
        
        .btn-loading i.bi {
            display: none;
        }
        
        .btn-loading::after {
            content: "";
            position: absolute;
            width: 16px;
            height: 16px;
            top: calc(50% - 8px);
            left: calc(50% - 20px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s infinite linear;
        }
        
        /* Toast notification styles */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 15px 20px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out, fadeOut 0.5s ease-out 3.5s forwards;
            position: relative;
            overflow: hidden;
        }
        
        .toast::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
        }
        
        .toast.success::before {
            background-color: #28a745;
        }
        
        .toast.error::before {
            background-color: #dc3545;
        }
        
        .toast-icon {
            margin-right: 15px;
            font-size: 20px;
        }
        
        .toast.success .toast-icon {
            color: #28a745;
        }
        
        .toast.error .toast-icon {
            color: #dc3545;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .toast-message {
            color: #666;
            font-size: 14px;
        }
        
        .toast-close {
            color: #999;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            margin-left: 10px;
        }
        
        .toast-close:hover {
            color: #666;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .dashboard-container {
                padding: 15px;
            }
            
            .toast-container {
                left: 20px;
                right: 20px;
            }
            
            .toast {
                min-width: auto;
                max-width: none;
                width: calc(100% - 40px);
            }
        }

        @media (max-width: 576px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
        
        /* Category distribution table styles */
        .risk-distribution-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .risk-distribution-table th,
        .risk-distribution-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .risk-distribution-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        .risk-distribution-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .risk-distribution-table tr:hover {
            background-color: #e9ecef;
        }
        
        .risk-distribution-table tr.table-footer {
            font-weight: bold;
            background-color: #e2e6ea;
        }
        
        .risk-distribution-table .category-name {
            text-align: left;
            font-weight: 500;
        }
        
        /* Entity and subcategory row styles */
        .risk-distribution-table .entity-row {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .risk-distribution-table .entity-row td:first-child {
            font-weight: 600;
            position: relative;
        }
        
        .risk-distribution-table .entity-row td:first-child::before {
            content: "▶";
            margin-right: 8px;
            font-size: 10px;
            color: #666;
            display: inline-block;
            transition: transform 0.2s;
        }
        
        .risk-distribution-table .entity-row.expanded td:first-child::before {
            transform: rotate(90deg);
        }
        
        .risk-distribution-table .subcategory-row {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0;
            display: none; /* Hidden by default */
        }
        
        .risk-distribution-table .entity-row.expanded + .subcategory-row,
        .risk-distribution-table .entity-row.expanded + .subcategory-row + .subcategory-row,
        .risk-distribution-table .entity-row.expanded + .subcategory-row + .subcategory-row + .subcategory-row {
            display: table-row; /* Show when parent is expanded */
        }
        
        .risk-distribution-table .subcategory-row td:first-child {
            padding-left: 25px;
            font-weight: normal;
            font-style: italic;
            color: #555;
        }
        
        .risk-distribution-table .subcategory-row:hover {
            background-color: #f5f5f5;
        }
        
        /* Risk level indicator dots */
        .risk-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .no-risk-dot {
            background-color: #28a745;
        }
        
        .at-risk-dot {
            background-color: #ffc107;
        }
        
        .high-risk-dot {
            background-color: #dc3545;
        }

        .executive-summary {
            background: linear-gradient(to right, #f9f9f9, #f0f8ff);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .summary-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .summary-highlight-box {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }

        .summary-ratio {
            margin-bottom: 15px;
        }

        .ratio-visual {
            margin-bottom: 10px;
        }

        .ratio-bar {
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            display: flex;
        }

        .ratio-fill {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .ratio-fill.preventive {
            background: linear-gradient(to right, #4CAF50, #8BC34A);
        }

        .ratio-fill.reactive {
            background: linear-gradient(to right, #FF9800, #FFC107);
        }

        .ratio-legend {
            display: flex;
            justify-content: space-around;
            font-size: 14px;
        }

        .ratio-legend span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .summary-tagline {
            font-style: italic;
            margin: 0;
            color: #555;
        }

        .summary-intro {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
            padding-left: 15px;
        }

        .summary-columns {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
        }

        .summary-column {
            flex: 1;
        }

        .summary-list {
            padding-left: 20px;
        }

        .summary-list li {
            margin-bottom: 10px;
            position: relative;
        }

        .summary-insight {
            background: #f8f4ff;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-top: 20px;
        }

        .summary-insight i {
            font-size: 24px;
            color: #673AB7;
        }

        .summary-insight p {
            margin: 0;
            font-size: 14px;
        }

        .summary-conclusion {
            background: #f1f8e9;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #8BC34A;
        }

        .summary-conclusion p {
            margin: 0;
            font-size: 15px;
        }

        @media (max-width: 768px) {
            .summary-columns {
                flex-direction: column;
            }
        }
        
        /* Systems overview table styles */
        .systems-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0;
        }
        
        .systems-table th,
        .systems-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .systems-table thead th {
            background-color: #f8f9fa;
            color: #333;
            font-weight: 600;
            position: relative;
        }
        
        .systems-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .systems-table .system-name {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .systems-table .category {
            color: #666;
            font-style: italic;
        }
        
        .systems-table .vendor {
            color: #495057;
        }
        
        .systems-table .status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .systems-table .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .systems-table .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .systems-table .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .systems-table .rating {
            font-size: 1.1rem;
            letter-spacing: 1px;
        }
        
        .rating-legend {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #8c857d;
        }
        
        .rating-legend h5 {
            color: #555;
            margin-bottom: 10px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        
        .rating-legend .indicator {
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: #666;
        }
        
        #systems-overview .card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            border: none;
        }
        
        .help-floating-btn i {
            font-size: 1.2rem;
        }
    </style>
</head>
<body class="luxury-dashboard">
    <div class="header">
        <h2>SENTION</h2>
        <div class="navbar-links">
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='anstalld') }}" class="{{ 'active' if current_category == 'anstalld' else '' }}">
                    Anställd
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar individuella insatser på medarbetarnivå för samtliga anställda inom företaget                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='grupp') }}" class="{{ 'active' if current_category == 'grupp' else '' }}">
                    Grupp
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar aktiviteter och insatser för teamutveckling, utbildning och förbättringsarbete på gruppnivå                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='organisation') }}" class="{{ 'active' if current_category == 'organisation' else '' }}">
                    Organisation
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-building"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar övergripande insatser och policys som berör hela organisationen                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='foretagsledning') }}" class="{{ 'active' if current_category == 'foretagsledning' else '' }}">
                    Företagsledning
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-briefcase"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar insatser specifikt relaterade till högsta ledningen: VD, ledningsgrupp och styrelse                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='managers') }}" class="{{ 'active' if current_category == 'managers' else '' }}">
                    Managers
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-person-badge"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar insatser specifikt för mellanchefer med personalansvar, som avdelningschefer och områdeschefer                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='supervisors') }}" class="{{ 'active' if current_category == 'supervisors' else '' }}">
                    Supervisors
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-person-check"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar insatser specifikt för första linjens chefer, som teamledare, gruppledare och arbetsledare                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('home', category='system') }}" class="{{ 'active' if current_category == 'system' else '' }}">
                    System
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-gear"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar systemrelaterad information och inställningar
                    </div>
                </div>
            </div>
            
            <div class="info-tooltip">
                <a href="{{ url_for('dashboard') }}" class="{{ 'active' if current_category == 'dashboard' else '' }}">
                    Dashboard
                </a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-speedometer2"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Visar sammanfattande information och insikter från alla sektioner
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-buttons">
            <div class="info-tooltip">
                <a href="{{ url_for('profile') }}" class="profile-btn"><i class="bi bi-person"></i> Min profil</a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-person"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Hantera din användarprofil och personliga inställningar
                    </div>
                </div>
            </div>
            
            {% if session.role == 'admin' %}
            <div class="info-tooltip">
                <a href="{{ url_for('admin_users') }}" class="admin-btn"><i class="bi bi-gear"></i> Användarhantering</a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-gear"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Administrera användare, behörigheter och systemfunktioner
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="info-tooltip">
                <a href="{{ url_for('logout') }}" class="logout-btn"><i class="bi bi-box-arrow-right"></i> Logga ut</a>
                <div class="info-tooltip-content">
                    <div class="info-icon">
                        <i class="bi bi-box-arrow-right"></i>
                    </div>
                    <div class="info-tooltip-text">
                        Logga ut från systemet och avsluta din session
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="dashboard-container">
            <h2>Dashboard</h2>
            
            <!-- Export buttons -->
            <div class="export-controls" style="display: flex; gap: 15px; margin-bottom: 30px; justify-content: flex-end;">
                <button id="export-pdf" class="btn" style="background-color: #dc3545; color: white; padding: 8px 15px; border-radius: 6px; border: none;">
                    <i class="bi bi-file-earmark-pdf"></i> Exportera som PDF
                </button>
                <button id="export-csv" class="btn" style="background-color: #28a745; color: white; padding: 8px 15px; border-radius: 6px; border: none; display: none;">
                    <i class="bi bi-file-earmark-excel"></i> Exportera som CSV
                </button>
            </div>
            
            <!-- SUMMARY SECTION (Moved to top) -->
            <div class="dashboard-section">
                <h3>
                    Sammanfattning 
                    <button id="refresh-data" class="btn btn-sm btn-outline-secondary" style="margin-left: 10px; padding: 2px 8px;">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <small id="last-updated" style="font-size: 0.75rem; font-weight: normal; color: #6c757d; float: right;"></small>
                </h3>
                
                <!-- Overall stats cards -->
                <div class="summary-cards" style="margin-bottom: 30px;">
                    <div class="summary-card" style="border-left: 4px solid #28a745;">
                        <h4>Interventioner för Grön Grupp</h4>
                        <p id="green-group-count" style="font-size: 32px; color: #28a745; font-weight: 700;">0</p>
                        <div class="trend">
                            <i class="bi bi-arrow-up trend-up"></i> <span id="green-group-trend">0%</span> sedan förra månaden
                        </div>
                    </div>
                    <div class="summary-card" style="border-left: 4px solid #ffc107;">
                        <h4>Interventioner för Gul Grupp</h4>
                        <p id="yellow-group-count" style="font-size: 32px; color: #ffc107; font-weight: 700;">0</p>
                        <div class="trend">
                            <i class="bi bi-arrow-down trend-down"></i> <span id="yellow-group-trend">0%</span> sedan förra månaden
                        </div>
                    </div>
                    <div class="summary-card" style="border-left: 4px solid #dc3545;">
                        <h4>Interventioner för Röd Grupp</h4>
                        <p id="red-group-count" style="font-size: 32px; color: #dc3545; font-weight: 700;">0</p>
                        <div class="trend">
                            <i class="bi bi-arrow-up trend-up"></i> <span id="red-group-trend">0</span> sedan förra månaden
                        </div>
                    </div>
                    <div class="summary-card">
                        <h4>Totala interventionsresurser</h4>
                        <p id="total-resources" style="font-size: 32px; color: #28a745; font-weight: 700;">0</p>
                        <div class="trend">
                            <i class="bi bi-arrow-up trend-up"></i> <span id="resources-trend">0</span> nya resurser
                        </div>
                    </div>
                    <div class="summary-card">
                        <h4>Interventionsfördelning</h4>
                        <p id="overall-distribution" style="font-size: 26px; font-weight: 700;">0% / 0% / 0%</p>
                        <div class="trend" style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #28a745; border-radius: 50%; margin-right: 5px;"></span>Ingen risk</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #ffc107; border-radius: 50%; margin-right: 5px;"></span>Risk</span>
                            <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #dc3545; border-radius: 50%; margin-right: 5px;"></span>Hög risk</span>
                        </div>
                    </div>
                </div>
                
                <!-- Category distribution tables -->
                <div class="category-distributions">
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Riskfördelning per kategori</h5>
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#categoryDistributionTable" aria-expanded="true" aria-controls="categoryDistributionTable">
                                <i class="bi bi-arrows-collapse"></i>
                            </button>
                        </div>
                        <div class="collapse show" id="categoryDistributionTable">
                            <div class="card-body">
                                <table class="risk-distribution-table">
                                    <thead>
                                        <tr>
                                            <th>Kategori</th>
                                            <th><span class="risk-dot no-risk-dot"></span> Ingen risk</th>
                                            <th><span class="risk-dot at-risk-dot"></span> Risk</th>
                                            <th><span class="risk-dot high-risk-dot"></span> Hög risk</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Anställd with subcategories -->
                                        <tr class="entity-row">
                                            <td class="category-name" style="font-weight: 600; background-color: #f8f9fa;">Anställd</td>
                                            <td id="anstalld-no-risk">0%</td>
                                            <td id="anstalld-at-risk">0%</td>
                                            <td id="anstalld-high-risk">0%</td>
                                            <td id="anstalld-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">HR</td>
                                            <td id="anstalld-hr-no-risk">0%</td>
                                            <td id="anstalld-hr-at-risk">0%</td>
                                            <td id="anstalld-hr-high-risk">0%</td>
                                            <td id="anstalld-hr-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Företagshälsovård</td>
                                            <td id="anstalld-fhv-no-risk">0%</td>
                                            <td id="anstalld-fhv-at-risk">0%</td>
                                            <td id="anstalld-fhv-high-risk">0%</td>
                                            <td id="anstalld-fhv-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Andra leverantörer</td>
                                            <td id="anstalld-andra-no-risk">0%</td>
                                            <td id="anstalld-andra-at-risk">0%</td>
                                            <td id="anstalld-andra-high-risk">0%</td>
                                            <td id="anstalld-andra-total">0</td>
                                        </tr>
                                        
                                        <!-- Grupp with subcategories -->
                                        <tr class="entity-row">
                                            <td class="category-name" style="font-weight: 600; background-color: #f8f9fa;">Grupp</td>
                                            <td id="grupp-no-risk">0%</td>
                                            <td id="grupp-at-risk">0%</td>
                                            <td id="grupp-high-risk">0%</td>
                                            <td id="grupp-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">HR</td>
                                            <td id="grupp-hr-no-risk">0%</td>
                                            <td id="grupp-hr-at-risk">0%</td>
                                            <td id="grupp-hr-high-risk">0%</td>
                                            <td id="grupp-hr-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Företagshälsovård</td>
                                            <td id="grupp-fhv-no-risk">0%</td>
                                            <td id="grupp-fhv-at-risk">0%</td>
                                            <td id="grupp-fhv-high-risk">0%</td>
                                            <td id="grupp-fhv-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Andra leverantörer</td>
                                            <td id="grupp-andra-no-risk">0%</td>
                                            <td id="grupp-andra-at-risk">0%</td>
                                            <td id="grupp-andra-high-risk">0%</td>
                                            <td id="grupp-andra-total">0</td>
                                        </tr>
                                        
                                        <!-- Organisation with subcategories -->
                                        <tr class="entity-row">
                                            <td class="category-name" style="font-weight: 600; background-color: #f8f9fa;">Organisation</td>
                                            <td id="organisation-no-risk">0%</td>
                                            <td id="organisation-at-risk">0%</td>
                                            <td id="organisation-high-risk">0%</td>
                                            <td id="organisation-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">HR</td>
                                            <td id="organisation-hr-no-risk">0%</td>
                                            <td id="organisation-hr-at-risk">0%</td>
                                            <td id="organisation-hr-high-risk">0%</td>
                                            <td id="organisation-hr-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Företagshälsovård</td>
                                            <td id="organisation-fhv-no-risk">0%</td>
                                            <td id="organisation-fhv-at-risk">0%</td>
                                            <td id="organisation-fhv-high-risk">0%</td>
                                            <td id="organisation-fhv-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Andra leverantörer</td>
                                            <td id="organisation-andra-no-risk">0%</td>
                                            <td id="organisation-andra-at-risk">0%</td>
                                            <td id="organisation-andra-high-risk">0%</td>
                                            <td id="organisation-andra-total">0</td>
                                        </tr>
                                        
                                        <!-- Företagsledning with subcategories -->
                                        <tr class="entity-row">
                                            <td class="category-name" style="font-weight: 600; background-color: #f8f9fa;">Företagsledning</td>
                                            <td id="foretagsledning-no-risk">0%</td>
                                            <td id="foretagsledning-at-risk">0%</td>
                                            <td id="foretagsledning-high-risk">0%</td>
                                            <td id="foretagsledning-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">HR</td>
                                            <td id="foretagsledning-hr-no-risk">0%</td>
                                            <td id="foretagsledning-hr-at-risk">0%</td>
                                            <td id="foretagsledning-hr-high-risk">0%</td>
                                            <td id="foretagsledning-hr-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Företagshälsovård</td>
                                            <td id="foretagsledning-fhv-no-risk">0%</td>
                                            <td id="foretagsledning-fhv-at-risk">0%</td>
                                            <td id="foretagsledning-fhv-high-risk">0%</td>
                                            <td id="foretagsledning-fhv-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Andra leverantörer</td>
                                            <td id="foretagsledning-andra-no-risk">0%</td>
                                            <td id="foretagsledning-andra-at-risk">0%</td>
                                            <td id="foretagsledning-andra-high-risk">0%</td>
                                            <td id="foretagsledning-andra-total">0</td>
                                        </tr>
                                        
                                        <!-- Managers with subcategories -->
                                        <tr class="entity-row">
                                            <td class="category-name" style="font-weight: 600; background-color: #f8f9fa;">Managers</td>
                                            <td id="managers-no-risk">0%</td>
                                            <td id="managers-at-risk">0%</td>
                                            <td id="managers-high-risk">0%</td>
                                            <td id="managers-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">HR</td>
                                            <td id="managers-hr-no-risk">0%</td>
                                            <td id="managers-hr-at-risk">0%</td>
                                            <td id="managers-hr-high-risk">0%</td>
                                            <td id="managers-hr-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Företagshälsovård</td>
                                            <td id="managers-fhv-no-risk">0%</td>
                                            <td id="managers-fhv-at-risk">0%</td>
                                            <td id="managers-fhv-high-risk">0%</td>
                                            <td id="managers-fhv-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Andra leverantörer</td>
                                            <td id="managers-andra-no-risk">0%</td>
                                            <td id="managers-andra-at-risk">0%</td>
                                            <td id="managers-andra-high-risk">0%</td>
                                            <td id="managers-andra-total">0</td>
                                        </tr>
                                        
                                        <!-- Supervisors with subcategories -->
                                        <tr class="entity-row">
                                            <td class="category-name" style="font-weight: 600; background-color: #f8f9fa;">Supervisors</td>
                                            <td id="supervisors-no-risk">0%</td>
                                            <td id="supervisors-at-risk">0%</td>
                                            <td id="supervisors-high-risk">0%</td>
                                            <td id="supervisors-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">HR</td>
                                            <td id="supervisors-hr-no-risk">0%</td>
                                            <td id="supervisors-hr-at-risk">0%</td>
                                            <td id="supervisors-hr-high-risk">0%</td>
                                            <td id="supervisors-hr-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Företagshälsovård</td>
                                            <td id="supervisors-fhv-no-risk">0%</td>
                                            <td id="supervisors-fhv-at-risk">0%</td>
                                            <td id="supervisors-fhv-high-risk">0%</td>
                                            <td id="supervisors-fhv-total">0</td>
                                        </tr>
                                        <tr class="subcategory-row">
                                            <td class="category-name" style="padding-left: 25px;">Andra leverantörer</td>
                                            <td id="supervisors-andra-no-risk">0%</td>
                                            <td id="supervisors-andra-at-risk">0%</td>
                                            <td id="supervisors-andra-high-risk">0%</td>
                                            <td id="supervisors-andra-total">0</td>
                                        </tr>
                                        
                                        <!-- Total row -->
                                        <tr class="table-footer">
                                            <td class="category-name">Totalt</td>
                                            <td id="total-no-risk">0%</td>
                                            <td id="total-at-risk">0%</td>
                                            <td id="total-high-risk">0%</td>
                                            <td id="interventions-total">0</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 1. EXECUTIVE SUMMARY Section -->
            <div id="executive-summary" class="dashboard-section">
                <h3>Executive Summary</h3>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; line-height: 1.6;">
                    <p>
                        Organisationen visar en övergripande förbättring med en minskning på 5% av anställda i riskkategorin.
                        Dock har vi märkt en ökning av hög risk inom grupper, vilket kräver vidare utredning.
                        Fokusområden bör vara Team Alpha och Anställd 1 som visar tydliga tecken på hög risk.
                    </p>
                    <p>
                        Rekommenderade åtgärder:
                    </p>
                    <ul>
                        <li>Genomför riskbedömning för Team Alpha</li>
                        <li>Schemalägg uppföljningsmöte med Anställd 1</li>
                        <li>Granska senaste resurstilldelningar för Avdelning B</li>
                    </ul>
                </div>
            </div>
            
            <!-- 2. STRATEGIC HEALTH OPTIMIZATION Section -->
            <div class="dashboard-section">
                <div class="executive-summary">
                    <h3><i class="bi bi-lightning-charge"></i> Strategisk Hälsooptimering</h3>
                    
                    <div class="summary-container">
                        <div class="summary-highlight-box">
                            <div class="summary-ratio">
                                <div class="ratio-visual">
                                    <div class="ratio-bar">
                                        <div class="ratio-fill preventive" style="width: 70%;">70-80%</div>
                                        <div class="ratio-fill reactive" style="width: 30%;">20-30%</div>
                                    </div>
                                </div>
                                <div class="ratio-legend">
                                    <span><i class="bi bi-shield"></i> Förebyggande</span>
                                    <span><i class="bi bi-bandaid"></i> Reaktiva</span>
                                </div>
                            </div>
                            <p class="summary-tagline">Optimal fördelning för maximala resultat</p>
                        </div>
                        
                        <div class="summary-content">
                            <p class="summary-intro">
                                <strong>En proaktiv strategi ger högre avkastning.</strong> Vår analys visar att organisationer som prioriterar förebyggande hälsoinsatser upplever markant minskad sjukfrånvaro, ökad produktivitet och starkare arbetsgivarvarumärke.<sup>2,9</sup>
                            </p>
                            
                            <div class="summary-columns">
                                <div class="summary-column">
                                    <h4><i class="bi bi-shield-check"></i> Förebyggande Insatser (70-80%)</h4>
                                    <ul class="summary-list">
                                        <li><strong>Kontinuerliga hälsoscreeningar</strong> - Identifierar riskfaktorer innan de utvecklas till problem<sup>3,7</sup></li>
                                        <li><strong>Mental hälsoprogram</strong> - PLS och KBT med arbetsplatsinriktning förebygger stressrelaterad ohälsa<sup>1,6</sup></li>
                                        <li><strong>Strukturerad fysisk aktivitet</strong> - Bevisad effekt mot arbetsrelaterad stress<sup>1</sup></li>
                                        <li><strong>Organisatoriska justeringar</strong> - Systematiska förändringar som främjar hälsosam arbetsmiljö<sup>1,7</sup></li>
                                        <li><strong>Kompetenshöjande insatser</strong> - Utbildningar om hälsosamma levnadsvanor och stresshantering<sup>2</sup></li>
                                        <li><strong>Systematiskt arbetsmiljöarbete</strong> - Undersöka, bedöma, åtgärda och kontrollera risker<sup>11,8</sup></li>
                                        <li><strong>Arbetsmiljöronder</strong> - Regelbundna genomgångar av organisatorisk, social och fysisk arbetsmiljö<sup>3,8</sup></li>
                                    </ul>
                                </div>
                                
                                <div class="summary-column">
                                    <h4><i class="bi bi-bandaid"></i> Reaktiva Insatser (20-30%)</h4>
                                    <ul class="summary-list">
                                        <li><strong>Snabbresponssystem</strong> - Tidig identifiering och hantering när problem uppstår<sup>2</sup></li>
                                        <li><strong>Målinriktad rehabilitering</strong> - Strukturerat stöd för återgång till arbete<sup>1</sup></li>
                                        <li><strong>Personanpassade lösningar</strong> - Skräddarsydda åtgärder baserade på individuella behov<sup>3,5</sup></li>
                                        <li><strong>Incidenthantering</strong> - Upprättade rutiner för trakasserier, hot och våld<sup>3,4</sup></li>
                                    </ul>
                                    
                                    <div class="summary-insight">
                                        <i class="bi bi-graph-up-arrow"></i>
                                        <p>Studier visar att proaktivt hälsoarbete är 3-4 gånger mer kostnadseffektivt än reaktiva insatser.<sup>2</sup></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="summary-risk-factors" style="margin: 15px 0; background: #fff8f7; border-radius: 8px; padding: 15px; border-left: 4px solid #FF9800;">
                                <h4><i class="bi bi-exclamation-triangle"></i> Viktiga riskfaktorer att bevaka</h4>
                                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <h5>Organisatoriska</h5>
                                        <ul>
                                            <li>Långa arbetstider</li>
                                            <li>Anställningsotrygghet</li>
                                            <li>Otydliga mål</li>
                                        </ul>
                                    </div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <h5>Psykosociala</h5>
                                        <ul>
                                            <li>Höga krav/låg kontroll</li>
                                            <li>Rollkonflikter</li>
                                            <li>Arbetsrelaterad stress</li>
                                        </ul>
                                    </div>
                                    <div style="flex: 1; min-width: 200px;">
                                        <h5>Fysiska</h5>
                                        <ul>
                                            <li>Belastningsergonomi</li>
                                            <li>Repetitivt arbete</li>
                                            <li>Buller och vibrationer</li>
                                        </ul>
                                    </div>
                                </div>
                                <p style="font-size: 13px; margin-top: 10px;">Källa: Myndigheten för arbetsmiljökunskap<sup>10</sup></p>
                            </div>
                            
                            <div class="summary-conclusion">
                                <p>Genom att investera främst i förebyggande åtgärder kan din organisation skapa en resilient arbetsstyrka, samtidigt som ett välfungerande reaktivt system säkerställer att uppkomna problem hanteras effektivt.<sup>2,9,12</sup> Ett systematiskt arbetsmiljöarbete med löpande riskbedömning och medarbetardelaktighet är nyckeln till långsiktig framgång.<sup>11</sup></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-references" style="font-size: 12px; color: #666; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
                        <p>
                            <strong>Referenser:</strong><br>
                            <sup>1</sup> Folkhälsomyndigheten: <i>Insatser via företagshälsovården för att förebygga eller minska psykisk ohälsa</i><br>
                            <sup>2</sup> Healthy Lane: <i>Skillnaden mellan reaktivt och proaktivt hälsoarbete</i><br>
                            <sup>3</sup> Kunskapsguiden: <i>Olika sätt att förebygga</i><br>
                            <sup>4</sup> SKR: <i>Förebygga hot, våld och otillåten påverkan</i><br>
                            <sup>5</sup> Arbetsmiljöverket: <i>Arbetsanpassning och individuella åtgärder</i><br>
                            <sup>6</sup> Folkhälsomyndigheten: <i>Förebygga psykisk ohälsa i arbetslivet</i><br>
                            <sup>7</sup> SKR: <i>Ett systematiskt arbetsmiljöarbete främjar verksamhetsutveckling</i><br>
                            <sup>8</sup> Arbetsmiljöverket: <i>Risker och åtgärder för en tillgänglig arbetsmiljö</i><br>
                            <sup>9</sup> Regeringen: <i>Arbetsmiljöstrategin 2021-2025</i><br>
                            <sup>10</sup> Mynak: <i>Arbetsmiljö och psykisk hälsa</i><br>
                            <sup>11</sup> Arbetsmiljöverket: <i>Systematiskt arbetsmiljöarbete</i><br>
                            <sup>12</sup> Regeringen: <i>En god arbetsmiljö för framtiden - regeringens arbetsmiljöstrategi</i>
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- 4. VISUALIZATION Section -->
            <div class="dashboard-section" style="margin-bottom: 80px;">
                <h3>Visualisering</h3>
                <div class="data-visualization" style="margin-bottom: 20px; padding-bottom: 30px;">
                    <!-- Placeholder for Chart.js visualization -->
                    <div id="chart-container" style="display: flex; justify-content: center; align-items: center; height: 400px; position: relative;">
                        <p style="color: #888; font-style: italic;">Diagram kommer att visas här</p>
                    </div>
                    <div id="chart-controls" style="display: flex; justify-content: flex-end; margin-top: 10px;">
                        <!-- Toggle buttons will be added here by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- 5. ALL INTERVENTIONS Section -->
            <div id="items-section" class="dashboard-section" style="margin-top: 40px;">
                <h3><i class="bi bi-table"></i> Alla Intervention</h3>
                <p>Nedan visas alla interventioner. Du kan filtrera datan.</p>
                
                <!-- Simple Filter Section -->
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 16px; color: #555;">
                        <i class="bi bi-funnel"></i> Filtrera items
                    </h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 14px;">Grupp:</label>
                            <select id="items-category-filter" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                                <option value="all">Alla kategorier</option>
                                <option value="anstalld">Anställd</option>
                                <option value="grupp">Grupp</option>
                                <option value="organisation">Organisation</option>
                                <option value="foretagsledning">Företagsledning</option>
                                <option value="managers">Managers</option>
                                <option value="supervisors">Supervisors</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 14px;">Risknivå:</label>
                            <select id="items-risk-filter" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                                <option value="all">Alla risknivåer</option>
                                <option value="No">Ingen risk</option>
                                <option value="At">Risk</option>
                                <option value="High">Hög risk</option>
                            </select>
                        </div>
                        
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 14px;">Stakeholder:</label>
                            <input type="text" id="items-entity-filter" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background-color: white;" placeholder="Filtrera...">
                        </div>
                        
                        <div style="flex: 1; min-width: 120px;">
                            <label style="display: block; margin-bottom: 5px; color: #555; font-size: 14px;">Betyg:</label>
                            <select id="items-rating-filter" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; background-color: white;">
                                <option value="all">Alla betyg</option>
                                <option value="➕">➕</option>
                                <option value="➕➕">➕➕</option>
                                <option value="➕➕➕">➕➕➕</option>
                            </select>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: auto;">
                            <button id="apply-items-filters" style="padding: 6px 12px; background-color: #8c857d; border: none; color: white; border-radius: 4px; cursor: pointer;">
                                <i class="bi bi-funnel-fill"></i> Filtrera
                            </button>
                            <button id="reset-items-filters" style="padding: 6px 12px; background-color: #aaa; border: none; color: white; border-radius: 4px; cursor: pointer;">
                                <i class="bi bi-arrow-counterclockwise"></i> Återställ
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Items Table -->
                <div style="overflow-x: auto; border-radius: 10px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);">
                    <table id="items-table" style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #f5f5f5;">
                                <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-weight: 500;">Intervention</th>
                                <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-weight: 500;">Stakeholder</th>
                                <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-weight: 500;">Risknivå</th>
                                <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-weight: 500;">Grupp</th>
                                <th style="padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; font-weight: 500;">Betyg</th>
                            </tr>
                        </thead>
                        <tbody id="items-table-body">
                            <tr>
                                <td colspan="5" style="padding: 15px; text-align: center; border-bottom: 1px solid #ddd;">Laddar items data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Rating explanation for Intervention -->
                <div class="mt-3 rating-legend">
                    <h5>Omdöme förklaring:</h5>
                    <div class="indicator">➕ Rätt riskgrupp i rätt tid &nbsp;|&nbsp; ➕➕ Används i önskad utsträckning &nbsp;|&nbsp; ➕➕➕ Har avsedd effekt</div>
                </div>
            </div>
            
            <!-- 6. SYSTEMS OVERVIEW Section (Moved to last) -->
            <div class="dashboard-section" id="systems-overview" style="margin-top: 40px;">
                <h3>Systemöversikt</h3>
                <div class="card">
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table systems-table">
                                <thead>
                                    <tr>
                                        <th>System</th>
                                        <th>Kategori</th>
                                        <th>Leverantör</th>
                                        <th>Status</th>
                                        <th>Omdöme</th>
                                    </tr>
                                </thead>
                                <tbody id="systems-table-body">
                                    <!-- Systems data will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <a href="{{ url_for('home', category='system') }}" class="btn btn-outline-primary">
                                <i class="bi bi-gear"></i> Gå till systemhantering
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Rating explanation -->
                <div class="mt-3 rating-legend">
                    <h5>Omdöme förklaring:</h5>
                    <div class="indicator">➕ Grundläggande funktionalitet &nbsp;|&nbsp; ➕➕ Används effektivt i verksamheten &nbsp;|&nbsp; ➕➕➕ Ger mätbart värde och uppfyller alla behov</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast container -->
    <div class="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded');
            
            // Initialize Supabase client
            const supabaseUrl = '{{ supabase_url }}';
            const supabaseKey = '{{ supabase_key }}';
            const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
            
            // Toast notification function
            function showToast(type, title, message) {
                const toastContainer = document.querySelector('.toast-container');
                
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                // Create toast content
                let iconClass = type === 'success' ? 'bi-check-circle' : 'bi-exclamation-circle';
                
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="bi ${iconClass}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <div class="toast-close">
                        <i class="bi bi-x"></i>
                    </div>
                `;
                
                // Add to container
                toastContainer.appendChild(toast);
                
                // Add event listener for close button
                toast.querySelector('.toast-close').addEventListener('click', function() {
                    toast.remove();
                });
                
                // Auto remove after 4 seconds
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 4000);
            }
            
            // Function to load dashboard data
            async function loadDashboardData() {
                try {
                    showToast('success', 'Laddar data', 'Hämtar information från databasen...');
                    
                    // Fetch data for each category
                    const categories = ['anstalld', 'grupp', 'organisation', 'foretagsledning', 'managers', 'supervisors'];
                    const categoryData = {};
                    
                    // Check if data is available
                    let hasData = false;
                    
                    // Fetch items for each category
                    for (const category of categories) {
                        const { data, error } = await supabaseClient
                            .from('items')
                            .select('*')
                            .eq('category', category);
                            
                        if (error) {
                            console.error(`Error fetching ${category} data:`, error);
                            continue;
                        }
                        
                        categoryData[category] = data;
                        if (data && data.length > 0) {
                            hasData = true;
                        }
                    }
                    
                    // Only update chart if we have data
                    if (hasData) {
                        // Update chart
                        updateChartVisualization(categoryData);
                    } else {
                        // Clear chart container and show a message
                        const chartContainer = document.getElementById('chart-container');
                        chartContainer.innerHTML = '<p style="color: #888; font-style: italic; text-align: center; width: 100%;">Ingen data tillgänglig för visualisering</p>';
                        // Clear controls
                        document.getElementById('chart-controls').innerHTML = '';
                    }
                    
                    // Fetch all items for the items table
                    const { data: allItemsData, error: allItemsError } = await supabaseClient
                        .from('items')
                        .select('*');
                        
                    if (allItemsError) {
                        console.error('Error fetching all items:', allItemsError);
                    } else {
                        console.log(`Successfully fetched ${allItemsData?.length || 0} items for table`);
                        // Log the first item to see its structure and property names
                        if (allItemsData && allItemsData.length > 0) {
                            console.log('Sample item structure:', allItemsData[0]);
                            console.log('Available properties:', Object.keys(allItemsData[0]));
                        }
                        updateItemsTable(allItemsData || []);
                    }
                    
                    // Fetch resources with related user data for better context
                    const { data: resourcesData, error: resourcesError } = await supabaseClient
                        .from('resources')
                        .select('*, users(username, Organization)')
                        .order('created_at', { ascending: false });
                        
                    if (resourcesError) {
                        console.error('Error fetching resources:', resourcesError);
                    }
                    
                    // Update last updated timestamp
                    const now = new Date();
                    document.getElementById('last-updated').textContent = `Senast uppdaterad: ${now.toLocaleString('sv-SE')}`;
                    
                    // Calculate summary statistics
                    updateSummaryStatistics(categoryData, resourcesData);
                    
                    // Update resources table with the latest data if it exists
                    if (document.querySelector('.resource-table')) {
                        updateResourcesTable(resourcesData);
                    }
                    
                    // Update executive summary with insights from the data
                    updateExecutiveSummary(categoryData, resourcesData);
                    
                    showToast('success', 'Data laddad', 'Dashboard har uppdaterats med senaste informationen.');
                    
                    // Set up auto-refresh every 5 minutes to keep data fresh
                    setTimeout(loadDashboardData, 5 * 60 * 1000);
                    
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    showToast('error', 'Fel vid datahämtning', 'Kunde inte ladda dashboard-data. Vänligen försök igen.');
                }
            }
            
            // Function to update summary statistics
            function updateSummaryStatistics(categoryData, resourcesData) {
                // Setup category stats object
                const categoryStats = {
                    anstalld: { 
                        total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        hr: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        fhv: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        andra: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                    },
                    grupp: { 
                        total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        hr: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        fhv: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        andra: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                    },
                    organisation: { 
                        total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        hr: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        fhv: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        andra: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                    },
                    foretagsledning: { 
                        total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        hr: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        fhv: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        andra: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                    },
                    managers: { 
                        total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        hr: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        fhv: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        andra: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                    },
                    supervisors: { 
                        total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        hr: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        fhv: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                        andra: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                    },
                    total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                };
                
                // Count items for each risk level across all categories
                for (const category in categoryData) {
                    if (categoryData[category]) {
                        categoryData[category].forEach(item => {
                            // Determine subcategory based on the item's source or provider field
                            // This would be based on your actual data model
                            let subcategory = 'andra'; // Default to "Andra leverantörer"
                            
                            // Using the provider or source field to determine subcategory
                            // Adjust this logic based on your actual data structure
                            if (item.provider) {
                                if (item.provider.toLowerCase().includes('hr')) {
                                    subcategory = 'hr';
                                } else if (item.provider.toLowerCase().includes('företagshälsovård') || 
                                           item.provider.toLowerCase().includes('foretagshalso')) {
                                    subcategory = 'fhv';
                                }
                            }
                            
                            // Increment totals for this category
                            categoryStats[category].total.total++;
                            categoryStats[category][subcategory].total++;
                            categoryStats.total.total++;
                            
                            if (item.risk_level === 'No') {
                                categoryStats[category].total.noRisk++;
                                categoryStats[category][subcategory].noRisk++;
                                categoryStats.total.noRisk++;
                            } else if (item.risk_level === 'At') {
                                categoryStats[category].total.atRisk++;
                                categoryStats[category][subcategory].atRisk++;
                                categoryStats.total.atRisk++;
                            } else if (item.risk_level === 'High') {
                                categoryStats[category].total.highRisk++;
                                categoryStats[category][subcategory].highRisk++;
                                categoryStats.total.highRisk++;
                            }
                        });
                    }
                }
                
                // Calculate month-over-month changes (with simulated historical data for now)
                // In a real implementation, you would compare with last month's data from the database
                const prevMonthNoRisk = categoryStats.total.noRisk + Math.floor(categoryStats.total.noRisk * 0.05);
                const noRiskChangePercent = prevMonthNoRisk > 0 ? 
                    Math.round(((prevMonthNoRisk - categoryStats.total.noRisk) / prevMonthNoRisk) * 100) : 0;
                
                const prevMonthAtRisk = categoryStats.total.atRisk - Math.floor(categoryStats.total.atRisk * 0.08);
                const atRiskChangePercent = prevMonthAtRisk > 0 ? 
                    Math.round(((categoryStats.total.atRisk - prevMonthAtRisk) / prevMonthAtRisk) * 100) : 0;
                
                const prevMonthHighRisk = categoryStats.total.highRisk - 1;
                const highRiskChange = categoryStats.total.highRisk - prevMonthHighRisk;
                
                // Calculate new resources based on a percentage of the total (for demonstration)
                const newResourcesAdded = Math.max(1, Math.floor(categoryStats.total.total * 0.1)); // At least 1 if there are any resources
                
                // Update UI for each category and subcategory percentage
                const subcategories = ['hr', 'fhv', 'andra'];
                
                for (const category in categoryStats) {
                    if (category !== 'total') {
                        // Update entity total row
                        const stats = categoryStats[category].total;
                        const total = stats.total;
                        
                        // Calculate percentages for entity totals
                        const noRiskPercentage = total > 0 ? Math.round((stats.noRisk / total) * 100) : 0;
                        const atRiskPercentage = total > 0 ? Math.round((stats.atRisk / total) * 100) : 0;
                        const highRiskPercentage = total > 0 ? Math.round((stats.highRisk / total) * 100) : 0;
                        
                        // Update entity UI
                        document.getElementById(`${category}-no-risk`).textContent = `${noRiskPercentage}%`;
                        document.getElementById(`${category}-at-risk`).textContent = `${atRiskPercentage}%`;
                        document.getElementById(`${category}-high-risk`).textContent = `${highRiskPercentage}%`;
                        document.getElementById(`${category}-total`).textContent = total.toString();
                        
                        // Update subcategory rows
                        subcategories.forEach(subcategory => {
                            const subStats = categoryStats[category][subcategory];
                            const subTotal = subStats.total;
                            
                            // Calculate percentages for subcategory
                            const subNoRiskPercentage = subTotal > 0 ? Math.round((subStats.noRisk / subTotal) * 100) : 0;
                            const subAtRiskPercentage = subTotal > 0 ? Math.round((subStats.atRisk / subTotal) * 100) : 0;
                            const subHighRiskPercentage = subTotal > 0 ? Math.round((subStats.highRisk / subTotal) * 100) : 0;
                            
                            // Update subcategory UI
                            document.getElementById(`${category}-${subcategory}-no-risk`).textContent = `${subNoRiskPercentage}%`;
                            document.getElementById(`${category}-${subcategory}-at-risk`).textContent = `${subAtRiskPercentage}%`;
                            document.getElementById(`${category}-${subcategory}-high-risk`).textContent = `${subHighRiskPercentage}%`;
                            document.getElementById(`${category}-${subcategory}-total`).textContent = subTotal.toString();
                        });
                    }
                }
                
                // Update totals row in the table
                const noRiskPercentage = categoryStats.total.total > 0 ? 
                    Math.round((categoryStats.total.noRisk / categoryStats.total.total) * 100) : 0;
                const atRiskPercentage = categoryStats.total.total > 0 ? 
                    Math.round((categoryStats.total.atRisk / categoryStats.total.total) * 100) : 0;
                const highRiskPercentage = categoryStats.total.total > 0 ? 
                    Math.round((categoryStats.total.highRisk / categoryStats.total.total) * 100) : 0;
                
                document.getElementById('total-no-risk').textContent = `${noRiskPercentage}%`;
                document.getElementById('total-at-risk').textContent = `${atRiskPercentage}%`;
                document.getElementById('total-high-risk').textContent = `${highRiskPercentage}%`;
                document.getElementById('interventions-total').textContent = categoryStats.total.total.toString();
                
                // Update the summary cards with real data for each risk group
                document.getElementById('green-group-count').textContent = categoryStats.total.noRisk.toString();
                document.getElementById('green-group-trend').textContent = `${Math.abs(noRiskChangePercent)}%`;
                document.getElementById('green-group-trend').parentElement.querySelector('i').className = 
                    noRiskChangePercent >= 0 ? 'bi bi-arrow-up trend-up' : 'bi bi-arrow-down trend-down';
                
                document.getElementById('yellow-group-count').textContent = categoryStats.total.atRisk.toString();
                document.getElementById('yellow-group-trend').textContent = `${Math.abs(atRiskChangePercent)}%`;
                document.getElementById('yellow-group-trend').parentElement.querySelector('i').className = 
                    atRiskChangePercent <= 0 ? 'bi bi-arrow-down trend-down' : 'bi bi-arrow-up trend-up';
                
                document.getElementById('red-group-count').textContent = categoryStats.total.highRisk.toString();
                document.getElementById('red-group-trend').textContent = highRiskChange.toString();
                document.getElementById('red-group-trend').parentElement.querySelector('i').className = 
                    highRiskChange <= 0 ? 'bi bi-arrow-down trend-down' : 'bi bi-arrow-up trend-up';
                
                document.getElementById('total-resources').textContent = categoryStats.total.total.toString();
                document.getElementById('resources-trend').textContent = newResourcesAdded.toString();
                
                document.getElementById('overall-distribution').textContent = 
                    `${noRiskPercentage}% / ${atRiskPercentage}% / ${highRiskPercentage}%`;
            }
            
            // Function to update chart visualization
            function updateChartVisualization(categoryData) {
                // Access the chart container
                const ctx = document.createElement('canvas');
                const chartContainer = document.getElementById('chart-container');
                chartContainer.innerHTML = ''; // Clear the container
                chartContainer.appendChild(ctx);
                
                // Remove any existing toggle buttons to prevent duplication
                const controlsContainer = document.getElementById('chart-controls');
                controlsContainer.innerHTML = ''; // Clear any existing controls
                
                // Process category data for the chart
                const categories = ['anstalld', 'grupp', 'organisation', 'foretagsledning', 'managers', 'supervisors'];
                const categoryLabels = ['Anställd', 'Grupp', 'Organisation', 'Företagsledning', 'Managers', 'Supervisors'];
                
                // Initialize data arrays for different risk levels
                const noRiskData = [];
                const atRiskData = [];
                const highRiskData = [];
                
                // Calculate percentage data for each category
                categories.forEach(category => {
                    const catData = categoryData[category] || [];
                    const total = catData.length;
                    
                    if (total > 0) {
                        const noRiskCount = catData.filter(item => item.risk_level === 'No').length;
                        const atRiskCount = catData.filter(item => item.risk_level === 'At').length;
                        const highRiskCount = catData.filter(item => item.risk_level === 'High').length;
                        
                        noRiskData.push(Math.round((noRiskCount / total) * 100));
                        atRiskData.push(Math.round((atRiskCount / total) * 100));
                        highRiskData.push(Math.round((highRiskCount / total) * 100));
                    } else {
                        // No data for this category
                        noRiskData.push(0);
                        atRiskData.push(0);
                        highRiskData.push(0);
                    }
                });
                
                // Destroy existing chart if it exists
                if (window.chartInstance) {
                    window.chartInstance.destroy();
                }
                
                // Create the chart
                window.chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: categoryLabels,
                        datasets: [
                            {
                                label: 'Ingen risk',
                                data: noRiskData,
                                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                                borderColor: 'rgba(40, 167, 69, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Risk',
                                data: atRiskData,
                                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                borderColor: 'rgba(255, 193, 7, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Hög risk',
                                data: highRiskData,
                                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false,
                                title: {
                                    display: true,
                                    text: 'Kategorier'
                                }
                            },
                            y: {
                                stacked: false,
                                min: 0,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Procent (%)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Riskfördelning per kategori'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw}%`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Add toggle buttons
                // 1. Toggle between bar and pie chart
                const toggleButton = document.createElement('button');
                toggleButton.className = 'btn btn-sm chart-toggle-btn';
                toggleButton.style.cssText = 'background-color: #8c857d; color: white; padding: 5px 10px; border-radius: 4px; border: none;';
                toggleButton.innerHTML = '<i class="bi bi-pie-chart"></i> Visa som cirkeldiagram';
                
                // Add toggle functionality
                toggleButton.addEventListener('click', function() {
                    if (window.chartInstance.config.type === 'bar') {
                        // Switch to pie chart
                        createPieChart(categoryData);
                        this.innerHTML = '<i class="bi bi-bar-chart"></i> Visa som stapeldiagram';
                    } else {
                        // Switch back to bar chart without calling updateChartVisualization again
                        createBarChart(categoryData);
                        this.innerHTML = '<i class="bi bi-pie-chart"></i> Visa som cirkeldiagram';
                    }
                });
                
                controlsContainer.appendChild(toggleButton);
                
                // Function to create pie chart
                function createPieChart(categoryData) {
                    // Calculate overall distribution
                    let noRiskCount = 0;
                    let atRiskCount = 0;
                    let highRiskCount = 0;
                    let totalItems = 0;
                    
                    for (const category in categoryData) {
                        categoryData[category]?.forEach(item => {
                            totalItems++;
                            if (item.risk_level === 'No') noRiskCount++;
                            else if (item.risk_level === 'At') atRiskCount++;
                            else if (item.risk_level === 'High') highRiskCount++;
                        });
                    }
                    
                    // Destroy existing chart
                    window.chartInstance.destroy();
                    
                    // Create pie chart
                    window.chartInstance = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['Ingen risk', 'Risk', 'Hög risk'],
                            datasets: [{
                                label: 'Riskfördelning',
                                data: [noRiskCount, atRiskCount, highRiskCount],
                                backgroundColor: [
                                    'rgba(40, 167, 69, 0.7)',
                                    'rgba(255, 193, 7, 0.7)',
                                    'rgba(220, 53, 69, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(40, 167, 69, 1)',
                                    'rgba(255, 193, 7, 1)',
                                    'rgba(220, 53, 69, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'right',
                                },
                                title: {
                                    display: true,
                                    text: 'Fördelning av interventioner per risknivå'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const label = context.label || '';
                                            const value = context.formattedValue;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = Math.round((context.raw / total) * 100);
                                            return `${label}: ${value} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                // Function to create bar chart (extracted from duplicate code)
                function createBarChart(categoryData) {
                    // Calculate data again
                    const noRiskData = [];
                    const atRiskData = [];
                    const highRiskData = [];
                    
                    categories.forEach(category => {
                        const catData = categoryData[category] || [];
                        const total = catData.length;
                        
                        if (total > 0) {
                            const noRiskCount = catData.filter(item => item.risk_level === 'No').length;
                            const atRiskCount = catData.filter(item => item.risk_level === 'At').length;
                            const highRiskCount = catData.filter(item => item.risk_level === 'High').length;
                            
                            noRiskData.push(Math.round((noRiskCount / total) * 100));
                            atRiskData.push(Math.round((atRiskCount / total) * 100));
                            highRiskData.push(Math.round((highRiskCount / total) * 100));
                        } else {
                            noRiskData.push(0);
                            atRiskData.push(0);
                            highRiskData.push(0);
                        }
                    });
                    
                    // Destroy existing chart
                    window.chartInstance.destroy();
                    
                    // Create bar chart
                    window.chartInstance = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: categoryLabels,
                            datasets: [
                                {
                                    label: 'Ingen risk',
                                    data: noRiskData,
                                    backgroundColor: 'rgba(40, 167, 69, 0.7)',
                                    borderColor: 'rgba(40, 167, 69, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Risk',
                                    data: atRiskData,
                                    backgroundColor: 'rgba(255, 193, 7, 0.7)',
                                    borderColor: 'rgba(255, 193, 7, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Hög risk',
                                    data: highRiskData,
                                    backgroundColor: 'rgba(220, 53, 69, 0.7)',
                                    borderColor: 'rgba(220, 53, 69, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    stacked: false,
                                    title: {
                                        display: true,
                                        text: 'Kategorier'
                                    }
                                },
                                y: {
                                    stacked: false,
                                    min: 0,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Procent (%)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value + '%';
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                },
                                title: {
                                    display: true,
                                    text: 'Riskfördelning per kategori'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return `${context.dataset.label}: ${context.raw}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Function to update resources table
            function updateResourcesTable(resourcesData) {
                if (!resourcesData || resourcesData.length === 0) {
                    return;
                }
                
                const tableBody = document.querySelector('.resource-table tbody');
                tableBody.innerHTML = '';
                
                // Get all resources, not just the most recent 5
                const resources = resourcesData.slice(0, 10); // Show top 10 most recent
                
                // For each resource, create a row
                resources.forEach(resource => {
                    const row = document.createElement('tr');
                    
                    // Create the name cell - use the resource text or title
                    const nameCell = document.createElement('td');
                    nameCell.textContent = resource.title || resource.text.substring(0, 30) + (resource.text.length > 30 ? '...' : '');
                    row.appendChild(nameCell);
                    
                    // Create the category cell - use the actual category from database
                    const categoryCell = document.createElement('td');
                    const category = resource.category || determineCategory(resource.text);
                    categoryCell.textContent = getCategoryName(category);
                    row.appendChild(categoryCell);
                    
                    // Create the date cell with proper formatting
                    const dateCell = document.createElement('td');
                    const date = new Date(resource.created_at);
                    dateCell.textContent = date.toLocaleDateString('sv-SE');
                    row.appendChild(dateCell);
                    
                    // Create the risk cell using the actual risk level from database
                    const riskCell = document.createElement('td');
                    const riskBadge = document.createElement('span');
                    
                    // Use the actual risk level from database if available
                    let riskLevel = resource.risk_level || determineRiskLevel(resource.text);
                    
                    // Map database risk levels to display values
                    if (riskLevel === 'High' || riskLevel === 'high') {
                        riskBadge.className = 'risk-badge risk-high';
                        riskBadge.textContent = 'Hög risk';
                    } else if (riskLevel === 'At' || riskLevel === 'low') {
                        riskBadge.className = 'risk-badge risk-low';
                        riskBadge.textContent = 'Risk';
                    } else {
                        riskBadge.className = 'risk-badge risk-none';
                        riskBadge.textContent = 'Ingen risk';
                    }
                    
                    riskCell.appendChild(riskBadge);
                    row.appendChild(riskCell);
                    
                    // Add the row to the table
                    tableBody.appendChild(row);
                });
                
                // Update the visibility based on current filters
                applyCurrentFilters();
            }
            
            // Function to apply current filters (extracted to a separate function)
            function applyCurrentFilters() {
                const resourceTable = document.querySelector('.resource-table');
                if (!resourceTable) {
                    return;
                }
                
                const categoryFilter = document.getElementById('category-filter').value;
                const riskFilter = document.getElementById('risk-filter').value;
                const dateFilter = document.getElementById('date-filter').value;
                
                // Get all table rows except the header
                const rows = Array.from(resourceTable.querySelectorAll('tbody tr'));
                
                rows.forEach(row => {
                    const category = row.cells[1].textContent.trim();
                    const date = row.cells[2].textContent.trim();
                    const riskCell = row.cells[3].querySelector('.risk-badge');
                    let risk = '';
                    
                    if (riskCell.classList.contains('risk-none')) {
                        risk = 'none';
                    } else if (riskCell.classList.contains('risk-low')) {
                        risk = 'low';
                    } else if (riskCell.classList.contains('risk-high')) {
                        risk = 'high';
                    }
                    
                    // Apply category filter
                    const categoryMatch = categoryFilter === 'all' || category === categoryFilter;
                    
                    // Apply risk filter
                    const riskMatch = riskFilter === 'all' || risk === riskFilter;
                    
                    // Apply date filter
                    let dateMatch = true;
                    if (dateFilter !== 'all') {
                        const today = new Date();
                        const rowDate = new Date(date.split('-').reverse().join('-')); // Convert from DD-MM-YYYY to YYYY-MM-DD
                        
                        if (dateFilter === 'today') {
                            dateMatch = rowDate.toDateString() === today.toDateString();
                        } else if (dateFilter === 'week') {
                            const oneWeekAgo = new Date();
                            oneWeekAgo.setDate(today.getDate() - 7);
                            dateMatch = rowDate >= oneWeekAgo;
                        } else if (dateFilter === 'month') {
                            const oneMonthAgo = new Date();
                            oneMonthAgo.setMonth(today.getMonth() - 1);
                            dateMatch = rowDate >= oneMonthAgo;
                        }
                    }
                    
                    // Show/hide row based on all filters
                    if (categoryMatch && riskMatch && dateMatch) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
            
            // Function to determine category from resource text
            function determineCategory(text) {
                // Simple heuristic for demonstration - in reality you might have this data from the database
                const categories = ['Anställd', 'Grupp', 'Organisation', 'Företagsledning', 'Managers', 'Supervisors'];
                
                for (const category of categories) {
                    if (text.toLowerCase().includes(category.toLowerCase())) {
                        return category;
                    }
                }
                
                // If no specific match, distribute evenly for demonstration
                const randomIndex = Math.floor(Math.random() * categories.length);
                return categories[randomIndex];
            }
            
            // Function to determine risk level from resource text
            function determineRiskLevel(text) {
                // Simple heuristic for demonstration
                const lowRiskWords = ['förbättra', 'utveckla', 'optimera', 'risk'];
                const highRiskWords = ['kritisk', 'akut', 'omedelbart', 'hög risk', 'fara'];
                
                const textLower = text.toLowerCase();
                
                for (const word of highRiskWords) {
                    if (textLower.includes(word)) {
                        return 'high';
                    }
                }
                
                for (const word of lowRiskWords) {
                    if (textLower.includes(word)) {
                        return 'low';
                    }
                }
                
                return 'none';
            }
            
            // Function to update executive summary
            function updateExecutiveSummary(categoryData, resourcesData) {
                // Setup category stats object to track risk distributions
                const categoryStats = {
                    anstalld: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                    grupp: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                    organisation: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                    foretagsledning: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                    managers: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                    supervisors: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 },
                    total: { noRisk: 0, atRisk: 0, highRisk: 0, total: 0 }
                };
                
                // Count items for each risk level in each category
                for (const category in categoryData) {
                    if (categoryData[category]) {
                        categoryData[category].forEach(item => {
                            categoryStats[category].total++;
                            categoryStats.total.total++;
                            
                            if (item.risk_level === 'No') {
                                categoryStats[category].noRisk++;
                                categoryStats.total.noRisk++;
                            } else if (item.risk_level === 'At') {
                                categoryStats[category].atRisk++;
                                categoryStats.total.atRisk++;
                            } else if (item.risk_level === 'High') {
                                categoryStats[category].highRisk++;
                                categoryStats.total.highRisk++;
                            }
                        });
                    }
                }
                
                // Find notable items - highest risk entities in each category
                const highRiskItems = [];
                for (const category in categoryData) {
                    categoryData[category]?.forEach(item => {
                        if (item.risk_level === 'High') {
                            highRiskItems.push({
                                text: item.text,
                                entity: item.entity,
                                category: category
                            });
                        }
                    });
                }
                
                // Get most recent resources
                const recentResources = resourcesData?.slice(0, 3).map(r => r.text) || [];
                
                // Generate executive summary
                const executiveSummaryContainer = document.querySelector('#executive-summary div');
                
                // Calculate total percentages
                const totalStats = categoryStats.total;
                const totalItems = totalStats.total;
                const noRiskPercentage = totalItems > 0 ? Math.round((totalStats.noRisk / totalItems) * 100) : 0;
                const atRiskPercentage = totalItems > 0 ? Math.round((totalStats.atRisk / totalItems) * 100) : 0;
                const highRiskPercentage = totalItems > 0 ? Math.round((totalStats.highRisk / totalItems) * 100) : 0;
                
                // Identify categories with highest risk percentages
                const categoryLabels = {
                    'anstalld': 'Anställda',
                    'grupp': 'Grupper',
                    'organisation': 'Organisation',
                    'foretagsledning': 'Företagsledning',
                    'managers': 'Managers',
                    'supervisors': 'Supervisors'
                };
                
                // Find categories with highest risk percentages
                let highestRiskCategory = null;
                let highestRiskPercentage = 0;
                let highestAtRiskCategory = null;
                let highestAtRiskPercentage = 0;
                
                for (const category in categoryStats) {
                    if (category !== 'total') {
                        const stats = categoryStats[category];
                        if (stats.total > 0) {
                            const highRiskPercentage = Math.round((stats.highRisk / stats.total) * 100);
                            const atRiskPercentage = Math.round((stats.atRisk / stats.total) * 100);
                            
                            if (highRiskPercentage > highestRiskPercentage) {
                                highestRiskPercentage = highRiskPercentage;
                                highestRiskCategory = category;
                            }
                            
                            if (atRiskPercentage > highestAtRiskPercentage) {
                                highestAtRiskPercentage = atRiskPercentage;
                                highestAtRiskCategory = category;
                            }
                        }
                    }
                }
                
                // Identify focus areas - get up to 3 high risk items
                const focusItems = highRiskItems.slice(0, 3);
                
                let focusAreasText = 'Inga specifika fokusområden identifierade.';
                if (focusItems.length > 0) {
                    const itemDescriptions = focusItems.map(item => `${item.entity} (${getCategoryName(item.category)})`);
                    focusAreasText = `Fokusområden bör vara ${itemDescriptions.join(', ')} som visar tecken på hög risk.`;
                }
                
                // Generate category-specific insights
                let categoryInsights = '';
                
                if (highestRiskCategory) {
                    categoryInsights += `${categoryLabels[highestRiskCategory]} visar den högsta andelen interventioner med hög risk (${highestRiskPercentage}%). `;
                }
                
                if (highestAtRiskCategory && highestAtRiskCategory !== highestRiskCategory) {
                    categoryInsights += `${categoryLabels[highestAtRiskCategory]} har den högsta andelen interventioner med risk (${highestAtRiskPercentage}%). `;
                }
                
                // Check for categories with no interventions
                const emptyCategoriesList = [];
                for (const category in categoryStats) {
                    if (category !== 'total' && categoryStats[category].total === 0) {
                        emptyCategoriesList.push(categoryLabels[category]);
                    }
                }
                
                if (emptyCategoriesList.length > 0) {
                    categoryInsights += `${emptyCategoriesList.join(', ')} har inga registrerade interventioner och kan behöva ytterligare uppmärksamhet. `;
                }
                
                // Build the executive summary text
                const summaryText = `
                    <p>
                        Organisationens interventionsfördelning visar att ${noRiskPercentage}% avser områden utan risk, 
                        ${atRiskPercentage}% för områden med risk och ${highRiskPercentage}% för områden med hög risk.
                        Vi har identifierat ${highRiskItems.length} interventioner för högrisksituationer som kräver omedelbar uppmärksamhet.
                    </p>
                    <p>
                        ${categoryInsights}${focusAreasText}
                    </p>
                    <p>
                        Rekommenderade åtgärder:
                    </p>
                    <ul>
                        ${focusItems.length > 0 ? focusItems.map(item => 
                            `<li>Prioritera implementering av interventioner för ${item.entity}</li>`).join('') : 
                            '<li>Utveckla och implementera förebyggande interventioner för alla kategorier</li>'}
                        ${highestRiskCategory ? 
                            `<li>Genomför fördjupad riskanalys för ${categoryLabels[highestRiskCategory]}</li>` : ''}
                        ${emptyCategoriesList.length > 0 ? 
                            `<li>Utveckla interventionsstrategier för ${emptyCategoriesList.join(', ')}</li>` : ''}
                        <li>Schemalägg uppföljningsmöten för att utvärdera effektiviteten av högriskinterventioner</li>
                        <li>Omfördela resurser för att säkerställa att högriskområden har tillräckligt med stöd</li>
                    </ul>
                `;
                
                executiveSummaryContainer.innerHTML = summaryText;
            }
            
            // Helper function to get readable category name
            function getCategoryName(category) {
                const categoryMap = {
                    'anstalld': 'Anställd',
                    'grupp': 'Grupp',
                    'organisation': 'Organisation',
                    'foretagsledning': 'Företagsledning',
                    'managers': 'Managers',
                    'supervisors': 'Supervisors'
                };
                
                return categoryMap[category] || category;
            }
            
            // Filter functionality for resource table
            document.getElementById('apply-filters')?.addEventListener('click', function() {
                console.log('Applying filters');
                
                if (document.querySelector('.resource-table')) {
                    applyCurrentFilters();
                    
                    // Show success toast
                    showToast('success', 'Filter tillämpade', 'Tabellen har filtrerats enligt dina val.');
                }
            });
            
            // Reset filters button functionality
            document.getElementById('reset-filters')?.addEventListener('click', function() {
                // Reset all select elements to their default values
                document.getElementById('category-filter').value = 'all';
                document.getElementById('risk-filter').value = 'all';
                document.getElementById('date-filter').value = 'all';
                
                // Show all rows in the table if it exists
                const resourceTable = document.querySelector('.resource-table');
                if (resourceTable) {
                    const rows = resourceTable.querySelectorAll('tbody tr');
                    rows.forEach(row => {
                        row.style.display = '';
                    });
                }
                
                console.log('Filters reset');
                
                // Show success toast
                showToast('success', 'Filter återställda', 'Alla filter har återställts till standardvärden.');
            });
            
            // PDF Export functionality
            document.getElementById('export-pdf').addEventListener('click', function() {
                console.log('Starting PDF export...');
                const pdfButton = this;
                
                // Show loading state
                pdfButton.classList.add('btn-loading');
                pdfButton.textContent = 'Exporterar...';
                
                // Function to prompt for credentials if needed
                function promptForCredentials() {
                    // Create a modal dialog for entering credentials
                    const modalHTML = `
                        <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="loginModalLabel">Logga in för att generera PDF</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <form id="pdf-login-form">
                                            <div class="mb-3">
                                                <label for="pdf-login-email" class="form-label">E-post</label>
                                                <input type="email" class="form-control" id="pdf-login-email" required>
                                            </div>
                                            <div class="mb-3">
                                                <label for="pdf-login-password" class="form-label">Lösenord</label>
                                                <input type="password" class="form-control" id="pdf-login-password" required>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Avbryt</button>
                                        <button type="button" class="btn btn-primary" id="pdf-login-submit">Logga in & Generera PDF</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add the modal to the page
                    const modalContainer = document.createElement('div');
                    modalContainer.innerHTML = modalHTML;
                    document.body.appendChild(modalContainer);
                    
                    // Create a Bootstrap modal instance
                    const loginModal = new bootstrap.Modal(document.getElementById('loginModal'), {
                        backdrop: 'static',
                        keyboard: false
                    });
                    
                    // Show the modal
                    loginModal.show();
                    
                    // Handle the login and PDF generation
                    document.getElementById('pdf-login-submit').addEventListener('click', function() {
                        const email = document.getElementById('pdf-login-email').value;
                        const password = document.getElementById('pdf-login-password').value;
                        
                        if (!email || !password) {
                            alert('Både e-post och lösenord måste anges');
                            return;
                        }
                        
                        // Close the modal
                        loginModal.hide();
                        
                        // Reset button state to loading
                        pdfButton.classList.add('btn-loading');
                        pdfButton.textContent = 'Exporterar...';
                        
                        // Generate PDF with credentials
                        generatePDF(email, password);
                    });
                    
                    // Reset the PDF button state
                    pdfButton.classList.remove('btn-loading');
                    pdfButton.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Exportera som PDF';
                }
                
                // Function to generate PDF with or without credentials
                function generatePDF(username = null, password = null) {
                    // Prepare request data
                    const requestData = {
                        url: window.location.href
                    };
                    
                    // Add credentials if provided
                    if (username) requestData.username = username;
                    if (password) requestData.password = password;
                    
                    // Make the API call
                    fetch('/generate_pdf', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('PDF generation response:', data);
                        
                        if (data.status === 'success') {
                            // Show success toast
                            showToast('success', 'PDF exporterad', 'Rapporten har exporterats som PDF-fil.');
                            
                            // Open the PDF in a new tab
                            if (data.file_url) {
                                window.open(data.file_url, '_blank');
                            }
                        } else if (data.needsCredentials) {
                            showToast('warning', 'Inloggning krävs', 'Du måste logga in igen för att kunna generera en PDF.');
                            
                            // Prompt for credentials
                            promptForCredentials();
                            return;
                        } else {
                            // Show error toast
                            showToast('error', 'PDF export misslyckades', data.message || 'Kunde inte generera PDF.');
                        }
                    
                    // Reset button state
                    pdfButton.classList.remove('btn-loading');
                    pdfButton.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Exportera som PDF';
                    })
                    .catch(error => {
                        console.error('PDF export error:', error);
                        showToast('error', 'PDF export misslyckades', 'Ett fel uppstod vid genereringen av PDF.');
                        
                        // Reset button state
                        pdfButton.classList.remove('btn-loading');
                        pdfButton.innerHTML = '<i class="bi bi-file-earmark-pdf"></i> Exportera som PDF';
                    });
                }
                
                // Start PDF generation
                generatePDF();
            });
            
            // Remove CSV Export functionality - hide the button with CSS
            document.getElementById('export-csv').style.display = 'none';
            
            // Load data when page loads
            loadDashboardData();

            // Add event listener for refresh button
            document.getElementById('refresh-data').addEventListener('click', function() {
                const refreshButton = this;
                refreshButton.disabled = true;
                refreshButton.innerHTML = '<i class="bi bi-arrow-clockwise"></i>';
                refreshButton.classList.add('rotating');
                
                // Add a rotating animation class
                if (!document.querySelector('style#refresh-animation')) {
                    const style = document.createElement('style');
                    style.id = 'refresh-animation';
                    style.textContent = `
                        @keyframes rotate {
                            from { transform: rotate(0deg); }
                            to { transform: rotate(360deg); }
                        }
                        .rotating i {
                            animation: rotate 1s linear infinite;
                            display: inline-block;
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Reload dashboard data
                loadDashboardData().finally(() => {
                    refreshButton.disabled = false;
                    refreshButton.classList.remove('rotating');
                });
            });

            // Function to update the items table with data
            function updateItemsTable(allItemsData) {
                console.log('Updating items table with data');
                const tableBody = document.getElementById('items-table-body');
                if (!tableBody) {
                    console.error('Could not find table body element');
                    return;
                }
                
                // Clear existing rows
                tableBody.innerHTML = '';
                
                // If no data, show message
                if (!allItemsData || allItemsData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" style="padding: 15px; text-align: center; border-bottom: 1px solid #ddd;">Kunde inte ansluta till databasen. Vänligen ladda om sidan.</td></tr>';
                    return;
                }
                
                // Create and append rows
                allItemsData.forEach(item => {
                    const row = document.createElement('tr');
                    row.style.borderBottom = '1px solid #eee';
                    
                    // Add hover effect
                    row.onmouseover = function() {
                        this.style.backgroundColor = '#f9f9f9';
                    };
                    row.onmouseout = function() {
                        this.style.backgroundColor = '';
                    };
                    
                    // Determine risk color
                    let riskColor = '#777';
                    let riskBg = '#f8f8f8';
                    let riskText = 'Okänd';
                    
                    if (item.risk_level === 'No') {
                        riskColor = '#155724';
                        riskBg = '#d4edda';
                        riskText = 'Ingen risk';
                    } else if (item.risk_level === 'At') {
                        riskColor = '#856404';
                        riskBg = '#fff3cd';
                        riskText = 'Risk';
                    } else if (item.risk_level === 'High') {
                        riskColor = '#721c24';
                        riskBg = '#f8d7da';
                        riskText = 'Hög risk';
                    }
                    
                    // Format rating value if it exists
                    // Try different possible property names for rating
                    let rating = '-';
                    // List of potential property names for rating (case insensitive)
                    const ratingProperties = ['rating', 'betyg', 'grade', 'score', 'rating_value'];
                    
                    // Log all property names for debugging (only for the first item)
                    if (allItemsData.indexOf(item) === 0) {
                        console.log('All item properties:', Object.keys(item));
                    }
                    
                    // Check for rating in all possible properties (case insensitive)
                    for (const prop of Object.keys(item)) {
                        if (ratingProperties.includes(prop.toLowerCase())) {
                            rating = item[prop];
                            break;
                        }
                    }
                    
                    // Add data cells with styling
                    row.innerHTML = `
                        <td style="padding: 12px 15px;">${escapeHtml(item.text || '')}</td>
                        <td style="padding: 12px 15px;">${escapeHtml(item.entity || '')}</td>
                        <td style="padding: 12px 15px;">
                            <span style="display: inline-block; padding: 3px 8px; border-radius: 3px; background-color: ${riskBg}; color: ${riskColor}; font-size: 0.9em;">
                                ${riskText}
                            </span>
                        </td>
                        <td style="padding: 12px 15px;">${getCategoryName(item.category || '')}</td>
                        <td style="padding: 12px 15px;">${rating}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                // Apply any active filters after population
                applyItemsFilters();
            }
            
            // Function to get risk label
            function getRiskLabel(riskLevel) {
                switch(riskLevel) {
                    case 'No': return 'Ingen risk';
                    case 'At': return 'Risk';
                    case 'High': return 'Hög risk';
                    default: return riskLevel;
                }
            }
            
            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Filter functionality for items table
            function applyItemsFilters() {
                const categoryFilter = document.getElementById('items-category-filter').value;
                const riskFilter = document.getElementById('items-risk-filter').value;
                const entityFilter = document.getElementById('items-entity-filter').value.toLowerCase();
                const ratingFilter = document.getElementById('items-rating-filter').value;
                
                const rows = document.querySelectorAll('#items-table tbody tr');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    // Skip message rows
                    if (row.cells.length === 1) return;
                    
                    const categoryCell = row.cells[3].textContent.trim();
                    const riskCell = row.cells[2].textContent.trim();
                    const entityCell = row.cells[1].textContent.trim().toLowerCase();
                    const ratingCell = row.cells[4].textContent.trim();
                    
                    // Check if row passes all filters
                    const passCategory = categoryFilter === 'all' || getCategoryValue(categoryCell) === categoryFilter;
                    const passRisk = riskFilter === 'all' || getRiskValue(riskCell) === riskFilter;
                    const passEntity = entityFilter === '' || entityCell.includes(entityFilter);
                    
                    // Fix for rating filter - handle plus signs consistently
                    let passRating = ratingFilter === 'all';
                    if (!passRating) {
                        // Compare the exact string representation
                        passRating = ratingCell === ratingFilter;
                    }
                    
                    // Show/hide row based on filter results
                    if (passCategory && passRisk && passEntity && passRating) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show message if no results
                const messageRow = document.querySelector('#items-table tbody .no-results-row');
                if (messageRow) {
                    messageRow.remove(); // Remove existing message if any
                }
                
                if (visibleCount === 0 && rows.length > 0) {
                    const tbody = document.querySelector('#items-table tbody');
                    const messageRow = document.createElement('tr');
                    messageRow.className = 'no-results-row';
                    messageRow.innerHTML = `<td colspan="5" style="text-align: center; padding: 20px;">Inga matchande resultat hittades</td>`;
                    tbody.appendChild(messageRow);
                }
            }
            
            // Get category value from display name
            function getCategoryValue(displayName) {
                const categoryMap = {
                    'Anställd': 'anstalld', 
                    'Grupp': 'grupp',
                    'Organisation': 'organisation',
                    'Företagsledning': 'foretagsledning',
                    'Managers': 'managers',
                    'Supervisors': 'supervisors'
                };
                
                return categoryMap[displayName] || displayName.toLowerCase();
            }
            
            // Get risk value from display name
            function getRiskValue(displayName) {
                const riskMap = {
                    'Ingen risk': 'No',
                    'Risk': 'At',
                    'Hög risk': 'High'
                };
                
                return riskMap[displayName] || displayName;
            }
            
            // Add event listeners for filtering
            document.getElementById('apply-items-filters')?.addEventListener('click', function() {
                applyItemsFilters();
                showToast('success', 'Filter tillämpade', 'Tabellen har filtrerats enligt dina val.');
            });
            
            document.getElementById('reset-items-filters')?.addEventListener('click', function() {
                // Reset all filter elements
                document.getElementById('items-category-filter').value = 'all';
                document.getElementById('items-risk-filter').value = 'all';
                document.getElementById('items-entity-filter').value = '';
                document.getElementById('items-rating-filter').value = 'all';
                
                // Show all rows
                const rows = document.querySelectorAll('#items-table tbody tr');
                rows.forEach(row => {
                    row.style.display = '';
                });
                
                showToast('success', 'Filter återställda', 'Alla filter har återställts.');
            });

            // Set up collapsible category rows in risk distribution table
            const entityRows = document.querySelectorAll('.risk-distribution-table .entity-row');
            entityRows.forEach(row => {
                row.addEventListener('click', function() {
                    // Toggle expanded class on this row
                    this.classList.toggle('expanded');
                });
            });
            
            // Load systems data for the systems overview section
            async function loadSystemsData() {
                try {
                    // Initialize Supabase client
                    const supabaseUrl = "{{ supabase_url }}";
                    const supabaseKey = "{{ supabase_key }}";
                    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
                    
                    // Set auth token if user is logged in
                    const accessToken = "{{ session.get('access_token', '') }}";
                    const refreshToken = "{{ session.get('refresh_token', '') }}";
                    
                    if (accessToken && accessToken !== "") {
                        supabaseClient.auth.setSession({
                            access_token: accessToken,
                            refresh_token: refreshToken
                        });
                    }
                    
                    // Fetch system data from Supabase
                    const { data, error } = await supabaseClient
                        .from('system_data')
                        .select('*')
                        .order('kategori', { ascending: true });
                    
                    if (error) throw error;
                    
                    // Get the table body element
                    const tableBody = document.getElementById('systems-table-body');
                    tableBody.innerHTML = '';
                    
                    // Check if we have data
                    if (data && data.length > 0) {
                        // Add rows to the table
                        data.forEach(item => {
                            const row = document.createElement('tr');
                            
                            // Get status class based on the status value
                            let statusClass = 'status-pending';
                            if (item.status) {
                                const status = item.status.toLowerCase();
                                if (status.includes('aktiv') || status.includes('active')) {
                                    statusClass = 'status-active';
                                } else if (status.includes('inaktiv') || status.includes('inactive') || status.includes('utgått')) {
                                    statusClass = 'status-inactive';
                                }
                            }
                            
                            row.innerHTML = `
                                <td class="system-name">${escapeHtml(item.system) || '-'}</td>
                                <td class="category">${escapeHtml(item.kategori) || '-'}</td>
                                <td class="vendor">${escapeHtml(item.leverantor) || '-'}</td>
                                <td><span class="status ${statusClass}">${escapeHtml(item.status) || '-'}</span></td>
                                <td class="rating">${escapeHtml(item.omdome) || '-'}</td>
                            `;
                            
                            tableBody.appendChild(row);
                        });
                    } else {
                        // No data found
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td colspan="5" style="text-align: center; padding: 20px;">
                                Inga system har lagts till ännu. 
                                <a href="{{ url_for('home', category='system') }}">Gå till systemhantering</a> för att lägga till system.
                            </td>
                        `;
                        tableBody.appendChild(row);
                    }
                } catch (error) {
                    console.error('Error loading systems data:', error);
                    
                    // Show error message in the table
                    const tableBody = document.getElementById('systems-table-body');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="5" style="text-align: center; padding: 20px; color: #721c24;">
                                Ett fel uppstod när systemdata skulle hämtas: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
            
            // Load systems data when page loads
            loadSystemsData();
            
            // Add refresh button functionality to also refresh systems data
            document.getElementById('refresh-data')?.addEventListener('click', function() {
                loadSystemsData();
            });
        });
    </script>
</body>
</html> 